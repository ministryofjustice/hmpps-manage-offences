{% extends "layout.njk" %}
{% from "partials/nav.njk" import navBar with context %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "partials/linkedOffenceTable.njk" import linkedOffenceTable %}
{% from "govuk/components/breadcrumbs/macro.njk" import govukBreadcrumbs %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}

{% set pageTitle = applicationName + " - Schedules" %}
{% set pageId = "schedules" %}

{% block navBar %}
  {{ navBar("schedules") }}
{% endblock %}

{% block aside %}
  {{ govukBreadcrumbs({
    items: [
      {
        text: "Schedules",
        href: "/schedules"
      },
      {
        text: "Schedule " + fullSchedule.code
      }
    ]
  }) }}
{% endblock %}

{% block content %}
  <h1 class="govuk-heading-l govuk-!-margin-bottom-1">
    <span class="govuk-caption-l">{{ fullSchedule.act }}</span>
    Schedule {{ fullSchedule.code }}
  </h1>
  {% if fullSchedule.code !== 'PCSC and Legacy NOMIS' %}
    <p class="govuk-body govuk-!-font-size-16 govuk-!-padding-top-0">Review <a
          href={{ fullSchedule.url }} class="govuk-link" rel="noreferrer noopener"
          target="_blank">Schedule {{ fullSchedule.code }} of the {{ fullSchedule.act }}</a> on legislation.gov.uk
    </p>
  {% endif %}

  {% set tabRows = [] %}
  {% for part in fullSchedule.scheduleParts %}
    {% set labelDesc = "Part " + part.partNumber + partDesc if partDesc else "Part " + part.partNumber %}
    {% set tabRows = (tabRows.push(
      {
        label: labelDesc,
        id: "part-" + part.id,
        panel: {
        html: partTab(part, fullSchedule, csrfToken)
      }
      }
    ), tabRows) %}
  {% endfor %}

  {{ govukTabs({
    classes: 'borderless-tabs',
    items: tabRows
  }) }}

  {{ govukBackLink({
    text: "Back",
    href: '/schedules'
  }) }}
{% endblock %}

{% macro partTab(part, fullSchedule, csrfToken) %}

  {# TODO remove - this is temporary labelling for NOMIS legacy schedules #}
  {% if fullSchedule.code === 'PCSC and Legacy NOMIS' %}
    {% if part.partNumber ===  1 %}
      {% set partDesc = 'SDS between 4 and 7 years after 28 June 2022' %}
    {% elseif part.partNumber ===  2 %}
      {% set partDesc = 'SDS >7 years after 28 June 2022' %}
    {% elseif part.partNumber ===  3 %}
      {% set partDesc = 'Sec250 >7 years after 28 June 2022' %}
    {% elseif part.partNumber ===  4 %}
      {% set partDesc = 'Schedule 15 Part 1' %}
    {% elseif part.partNumber ===  5 %}
      {% set partDesc = 'Schedule 15 Part 2' %}
    {% elseif part.partNumber ===  6 %}
      {% set partDesc = 'Schedule 15 Part 3' %}
    {% elseif part.partNumber ===  7 %}
      {% set partDesc = 'SDS >7 years between 01 April 2020 and 28 June 2022' %}
    {% endif %}
  {% endif %}

  <div class="govuk-grid-row">
    {% if partDesc %}
      <div class="govuk-grid-column-one-half govuk-!-text-align-left">
        <h2 class="govuk-heading-m govuk-!-margin-bottom-0">
          {{ partDesc }}
        </h2>
      </div>
      {% if ('ROLE_UPDATE_OFFENCE_SCHEDULES' in user.roles) %}
        <div class="govuk-grid-column-one-half text-align-right">

          {{ govukButton({
            classes: "govuk-button--tertiary",
            text: "Link offences",
            preventDoubleClick: true,
            href: '/schedules/link-offences/' + fullSchedule.id + '/' + part.id,
            attributes: {  'data-qa': 'link-offences' }
          }) }}
        </div>
      {% endif %}
    {% else %}
      {% if ('ROLE_UPDATE_OFFENCE_SCHEDULES' in user.roles) %}
        <div class="govuk-grid-column-full text-align-right">

          {{ govukButton({
            classes: "govuk-button--tertiary",
            text: "Link offences",
            preventDoubleClick: true,
            href: '/schedules/link-offences/' + fullSchedule.id + '/' + part.id,
            attributes: {  'data-qa': 'link-offences' }
          }) }}
        </div>
      {% endif %}
    {% endif %}
  </div>

  {{ linkedOffenceTable(
    {
      offences: part.offences,
      scheduleId: fullSchedule.id,
      schedulePartId: part.id,
      csrfToken: csrfToken,
      user: user
    }
  ) }}
{% endmacro %}
